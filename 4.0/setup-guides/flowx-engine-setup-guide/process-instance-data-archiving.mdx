---
title: Partitioning & archiving
description: Improving data management using data partitioning and the archival processes.
---

## Partitioning

Partitioning involves splitting instance-related tables into multiple tables based on the `partition_id` of each entity. This process is managed by the database, which abstracts access to the partitioned data, so no changes are needed in the application code to locate data in specific partitions.

<Info>
Database Compatibility: Oracle and Postgres.
</Info>

## Archiving

Archiving is the process of copying detached tables to an external storage solution (such as another database or a data lake) and then removing them from the initial database.

- A cron job in FlowX will manage partitioning based on configured retention intervals.
- Old data and completed instances will be moved to detached and (optionally) compressed tables.

## Daily operations

Once set up, the partitioning and archiving process involves the following operations:

<Steps>
<Step title= "Partition ID Calculation">
The `partition_id` is automatically calculated based on the configured interval (DAY, WEEK, MONTH).
Example for daily partitioning: `2024-03-01 13:00:00` results in `partition_id = 124061`.
</Step>
<Step title="Retention Management">
Data older than the configured retention interval becomes eligible for detachment and compression.
</Step>
<Step title ="Archiving process">
- A cron job checks for eligible partitions.
- Eligible partitions are detached and optionally compressed.
- The process includes deactivating foreign keys, creating new archive tables, moving data references, reactivating foreign keys, and dropping the original partition.
</Step>
<Step title ="Space management">
- Detached tables remain in the database but occupy less space if compression is enabled.
- To free up space, move detached tables to another database or tablespace.
</Step>
</Steps>


<Info>
When enabling partitioning, please consider the following:

**Ensure Process Termination**: Make sure that process instances get terminated. chiving removes process instance data from the working data, making it not available in FlowX. Started instances should be finished before archiving takes place.

**Set Process Expiry**: In order to ensure that process instances are terminated before archiving, we recommend configuring process expiration.
</Info>


<Info>
Future schema updates or migrations will not affect detached tables. They retain the schema from the moment of detachment.
</Info>

## Configuring partitioning and archiving

<Info>
The Partitioning and Archiving feature is optional and can be configured as needed.
</Info>

This section contains environment variables that control the settings for data partitioning and archiving and also fo the archiving scheduler. These settings determine how data is segmented, retained, and managed, including compression and batch processing.


| Environment Variable                                     | Description                                                                  | Default Value                                                            | Possible Values                       |
| -------------------------------------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------- |
| `FLOWX_DATA_PARTITIONING_ENABLED`                        | Activates data partitioning.                                                 | `false`                                                                  | `true`, `false`                       |
| `FLOWX_DATA_PARTITIONING_INTERVAL`                       | Interval for partitioning (the time interval contained in a partition).      | `MONTH`                                                                  | `DAY`, `WEEK`, `MONTH`                |
| `FLOWX_DATA_PARTITIONING_RETENTION_INTERVALS`            | Number of intervals retained in the FlowX database (for partitioned tables). | `3`                                                                      | Integer values (e.g., `1`, `2`, `3`)  |
| `FLOWX_DATA_PARTITIONING_DETACHED_PARTITION_COMPRESSION` | Enables compression for archived (detached) partitions (Oracle only).        | `OFF`                                                                    | `OFF`, `BASIC`, `ADVANCED`            |
| `FLOWX_DATA_PARTITIONING_MOVED_DATA_BATCH_SIZE`          | Batch size for moving data (Postgres only).                                  | `5000`                                                                   | Integer values (e.g., `1000`, `5000`) |
| `SCHEDULER_DATA_PARTITIONING_ENABLED`                    | Activates the cron job for detaching and archiving partitions.               | `true`                                                                   | `true`, `false`                       |
| `SCHEDULER_DATA_PARTITIONING_CRON_EXPRESSION`            | Cron expression for the data partitioning scheduler.                         | `0 * * * * ?` -> every day during the night, at the start of every hour. | Cron expression (e.g., `0 0 1 * * ?`) |

<Info>
Compression for archived (detached) partitions is available only for Oracle DBs.
</Info>

<Info>
Batch size for moving data is available only for Postgres DBs.
</Info>


## Logging information

Partitioning and archiving actions are logged in two tables:

- `DATA_PARTITIONING_LOG`: For tracking detached partitions.
- `DATA_PARTITIONING_LOG_ENTRY`: For logging SQL commands executed for detachment.

## Enabling Partitioning and Elasticsearch indexing strategy

When partitioning is enabled, the Elasticsearch Kafka indexing strategy must also be enabled and configured on FlowX Engine setup.

<Card icon="info">
**Why?**

* When detaching process instances, data from Elasticsearch must also be deleted, not just the cache but also indexed keys (e.g., those indexed for data search on process instances).
</Card>

### Elasticsearch indexing configuration

Check the Elasticsearch indexing setup here:

<Card title ="Elasticsearch indexing setup" href="./configuring-elasticsearch-indexing/" icon ="link">
</Card>

The partitioning configuration must be aligned with the configuration extractred from the Kafka Elasticsearch Connector, especially with the following environment variables, so the intervals are similar:

### Index partitioning

* `transforms.routeTS.topic.format: "process_instance-${timestamp}"`: This value must start with the index name defined in the process-engine config: flowx.indexing.processInstance.index-name. In this example, the index name is prefixed with "process_instance-" and appended with a timestamp for dynamic index creation. For backward compatibility, the prefix must be "process_instance-". However, backward compatibility is not strictly required here.
yaml

* `transforms.routeTS.timestamp.format: "yyyyMMdd"`: This format ensures that timestamps are consistently represented and easily parsed when creating or searching for indices based on the process instance start date. You can adjust this value as needed (e.g., for monthly indexes, use "yyyyMM"). However, note that changing this format will cause existing indexed objects to remain unchanged, and update messages will be treated as new objects, indexed again in new indices. It is crucial to determine your index size and maintain consistency.

Check the following Kafka Elasticsearch Connector configuration example for more details:

<Card title ="Kafka Elasticsearch Connector" href="./configuring-elasticsearch-indexing/elasticsearch-indexing#kafka-elasticsearch-connector" icon="link">
</Card>


## Technical details

### Partition ID calculation
    
- The `partition_id` format: `LEVEL || YEAR || BIN_ID_OF_YEAR`. Calculated based on start date of `process_instance`, partition interval, and partition level.
- Example: For a timestamp `2024-03-01 13:00:00` and daily partitioning interval, the `partition_id` is `124061`.

### Detached and compressed tables
    
- Naming format: `archived__${table_name}__${interval_name}_${reference}`.
- Example: `archived__process_instance__monthly_2024_03`.